<!DOCTYPE html>
<html lang="en">

    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <title>Deeper Dive: Entities - Maxwell Forbes</title>
        <!-- NOTE: Twitter uses name='', og uses property='' -->
        <meta content="Deeper Dive: Entities - Maxwell Forbes" property="title"/>
        <meta content="Deeper Dive: Entities - Maxwell Forbes" property="og:title"/>
        <meta name="twitter:title" content="Deeper Dive: Entities - Maxwell Forbes"/>

        <link href='/website-3/assets/img/fav.png' rel='shortcut icon'>
<link href='/website-3/assets/css/tachyons.min.css' rel='stylesheet' type='text/css'/>
<link href='/website-3/assets/css/style.css' rel='stylesheet' type='text/css'/>
<link href='/website-3/assets/css/syntax/prism.default.css' rel='stylesheet' type='text/css'/>

<!-- NOTE: Twitter uses name='', og uses property='' -->

    <meta content='https://maxwellforbes.com/posts/typescript-ecs-entities/' property='og:url'/>
    
    <meta name='twitter:site' content='@maxforbes'/>
    
        <meta content="" property='og:description'/>
        <meta name='twitter:description' content=""/>
    
    <meta content="article" property="og:type"/>

<!-- - -->



    </head>

    <body class="lh-copy near-black pa0 f5 f4-ns sans-serif">
        

  <div class="mw7 mt3 mt4-ns mb3 center">

    <nav class="mh3 mh4-ns pv3 flex" aria-label="Main">
      <div class="w-50 tl">
        <a href="/website-3/" class="hover dim black" id="header">Maxwell Forbes</a>
      </div>
      <div class="w-50 tr">
        
          <!-- If you're on that page, don't show as a link. -->
          
            <a class="link hover-mid-gray ml3 pv1" href="/website-3/studio">
              Studio
            </a>
          
        
          <!-- If you're on that page, don't show as a link. -->
          
            <a class="link hover-mid-gray ml3 pv1" href="/website-3/research">
              Research
            </a>
          
        
      </div>
    </nav>

    <div class="mh3 mh4-ns bt b--black-80"></div>

    <main class="tl relative ph3 ph4-ns pt4 pb2 paddingOverride">
      
        <div class="mb4">
          <!-- Date -->
          
            <div class="fw600 light-silver mt1 ttu">
              
                07 Sep 2021
              
            </div>
          

          <!-- Title -->
          <h1 class="ttu tracked f3 f2-ns mt0 lh-title cb mb2">
            <!-- Kind of a hack for page title in a series of posts (e.g., sparking joy w/ python) -->
            
              Deeper Dive: Entities
            
          </h1>
          

        </div>
      

      <!-- Series header. -->
      
        <div class="ba b--black-80 mv5">
    <p class="bg-black-80 white mv0 pv2 ph3 b">
        <span class="fr ttu tracked dib white-60 f6 f5-ns">series</span>
        Building an ECS in TypeScript
    </p>

    <div class="pa3">
        
        <ol class="ma0">
            
                <li class="">
                    
                        <a href="/website-3/posts/typescript-ecs-what/" class="db pv1 link">
                            What is an ECS?
                        </a>
                    
                </li>
            
                <li class="">
                    
                        <a href="/website-3/posts/typescript-ecs-why/" class="db pv1 link">
                            Why build an ECS? Why TypeScript?
                        </a>
                    
                </li>
            
                <li class="">
                    
                        <a href="/website-3/posts/typescript-ecs-implementation/" class="db pv1 link">
                            A TypesScript ECS in 99 Lines of Code
                        </a>
                    
                </li>
            
                <li class="">
                    
                        <a href="/website-3/posts/typescript-ecs-tests/" class="db pv1 link">
                            Tests
                        </a>
                    
                </li>
            
                <li class="">
                    
                        <span class="b">
                            Deeper Dive: Entities
                        </span>
                    
                </li>
            
                <li class="">
                    
                        <a href="/website-3/posts/typescript-ecs-components/" class="db pv1 link">
                            Deeper Dive: Components
                        </a>
                    
                </li>
            
                <li class="">
                    
                        <a href="/website-3/posts/typescript-ecs-dirty-component-optimization/" class="db pv1 link">
                            Dirty Component Optimization
                        </a>
                    
                </li>
            
                <li class="">
                    
                        <a href="/website-3/posts/typescript-ecs-aspects/" class="db pv1 link">
                            Aspects
                        </a>
                    
                </li>
            
                <li class="">
                    
                        <a href="/website-3/posts/typescript-ecs-systems/" class="db pv1 link">
                            Deeper Dive: Systems
                        </a>
                    
                </li>
            
        </ol>

    </div>
</div>

      

      <div class="markdown-body">
        <p>Our Entity implementation is about as simple as can be.</p>
<pre class="language-ts"><code class="language-ts"><span class="token comment">/**<br> * An entity is just an ID. This is used to look up its associated<br> * Components.<br> */</span><br><span class="token keyword">type</span> <span class="token class-name">Entity</span> <span class="token operator">=</span> <span class="token builtin">number</span></code></pre>
<p>But let me use this as an excuse to tell a little story. The story is about the most beautiful refactor of my life.</p>
<h2 id="my-first-entity-implementation" tabindex="-1">My First <code>Entity</code> Implementation</h2>
<a class="dn" href="#my-first-entity-implementation"><span class="dn">Permalink to “My First Entity Implementation”</span> <span aria-hidden="true">#</span></a><p>When I was programming an ECS for the first time, I did what any good programmer would, and invented a pointless abstraction in fear of what the future might bring.</p>
<pre class="language-ts"><code class="language-ts"><span class="token keyword">class</span> <span class="token class-name">Entity</span> <span class="token punctuation">{</span><br>    <span class="token keyword">private</span> repr<span class="token operator">:</span> <span class="token builtin">string</span><br><br>    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token keyword">private</span> id<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token keyword">this</span><span class="token punctuation">.</span>repr <span class="token operator">=</span> <span class="token string">'Entity('</span> <span class="token operator">+</span> id <span class="token operator">+</span> <span class="token string">')'</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token keyword">public</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">string</span> <span class="token punctuation">{</span><br>        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>repr<span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre>
<p>I am being a bit harsh on myself here. After all, I had no idea what kinds of things programming a game would demand. Perhaps I’d find a dire need to squirrel away information inside the Entity?</p>
<h2 id="the-most-beautiful-refactor-of-my-life" tabindex="-1">The Most Beautiful Refactor of My Life</h2>
<a class="dn" href="#the-most-beautiful-refactor-of-my-life"><span class="dn">Permalink to “The Most Beautiful Refactor of My Life”</span> <span aria-hidden="true">#</span></a><p>I wrote that first implementation on October 30, 2016.</p>
<p>On July 13, 2018, nearly two years of programming later, I had built a pretty hefty codebase with this ECS engine as the backbone. It managed tens of thousands of Entities across a variety of levels. The Entities ranged from the player, to enemies, to items, to environment objects, to even pieces of the GUI. The <code>Entity</code> class was referenced across several dozen files.</p>
<p>But all this time, I’d never put anything else inside the <code>Entity</code> class. So I had a simple thought: could we just change it to a number? Would this possibly work?</p>
<p>There was no reason to except elegance. Wanting to change this was pure greed—but the greed where you want a program to be simpler just because it’s more beautiful that way.</p>
<p>Worth a try. I deleted the whole class, replacing it with the simple type alias above. Then, I changed the only place in the entire codebase an <code>Entity</code> was created, a single line in the ECS’s <code>addEntity()</code> function, from</p>
<pre class="language-ts"><code class="language-ts"><span class="token keyword">let</span> entity <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Entity</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>nextEntityID<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>to</p>
<pre class="language-ts"><code class="language-ts"><span class="token keyword">let</span> entity<span class="token operator">:</span> Entity <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>nextEntityID<span class="token punctuation">;</span></code></pre>
<p>… and that was it.</p>
<p>I pressed “compile.” The whole game compiled. No errors.</p>
<p>I ran the game. No problems.</p>
<p>I could not believe it.</p>

      </div>

      <!-- Series footer. -->
      
        <div class="ba b--black-10 mv5">
    <p class="bg-near-white black-60 mv0 pv2 ph3 b">
        <span class="fr ttu tracked dib black-30 f6 f5-ns">series</span>
        Building an ECS in TypeScript
    </p>

    <div class="pa3 flex">
        <div class="w-50 ma0">
            
            
                <p class="b ttu tracked ma0 black-30 f7 f6-ns">&larr; previous</p>
                <a href="/website-3/posts/typescript-ecs-tests/" class=" ma0 link">4. Tests</a>
            
        </div>
        <div class="w-50 ma0 tr">
            
            
                <p class="b ttu tracked ma0 black-30 f7 f6-ns">next &rarr;</p>
                <a href="/website-3/posts/typescript-ecs-components/" class=" ma0 link">6. Deeper Dive: Components</a>
            
        </div>
    </div>
</div>

      

      <!-- Email box. -->
      <!-- <hr /> -->
<!-- <div class="bt b--black-80 mt4"></div> -->
<div class="ba b--black-80 mt5 f6 f5-ns">
    <form style="text-align:center;" action="https://tinyletter.com/mbforbes" method="post" target="popupwindow"
        onsubmit="window.open('https://tinyletter.com/mbforbes', 'popupwindow', 'scrollbars=yes,width=800,height=600');return true">
        <p class="tc b">
            Monthly project and essay digest
        </p>
        <p class="tc measure center">
            <label for="tlemail">
                I send a summary every month of my new projects and essays.
                No spam, just me, Max. Unsub whenever.
            </label>
        </p>
        <p class="mb1">
            <input type="text" style="width:200px" name="email" id="tlemail" placeholder="your email"/>
            <input type="hidden" value="1" name="embed"/><input type="submit" value="Get on the list"/>
        </p>
        <p class="mt0 f7 f6-ns">
            <!-- via -->
            <img src='/website-3/assets/img/TinyLetter_Wordmark.png' style="height: 22px;"/>
        </p>
    </form>
</div>


      <!-- Garage footer. -->
      
    </main>
  </div>
  <footer class="mt5 f6 f5-ns mw7 center tc pt2 pb4 silver">
    <div class="mh3 mh4-ns bt b--silver mb1"></div>
    <a href="/website-3/about/" class="link silver hover-blue pv1">
      about me
    </a>
    | orig theme is
    <a href="http://github.com/muan/scribble" class="link silver hover-blue pv1">Scribble</a>
    <!-- <img src="https://maxwellforbes.com/data/img/scribble2.png" alt="scribble" class="mt4 db center" /> -->
  </footer>

  <!-- The wave -->
  <script>
    // settings
    let periods = 0.5;
    let baseDelay = 1; // s
    let charDelay = 0.1; // s
    let duration = 0.70; // s
    let startW = 400; // w
    let mag = 400; // +/- w
    let refresh = 0.016667; // s

    // computed vals
    let frames = duration / refresh;

    // state
    let updaters = [];
    let frameNs = [];

    function fontWeighter(idx) {
      frameNs[idx] += 1;
      let x = (frameNs[idx] / frames) * periods * 2 * Math.PI;
      let w = Math.round(startW + mag * Math.sin(x));
      document
        .getElementById("header")
        .children[idx]
        .style
        .fontWeight = w;
      if (frameNs[idx] >= frames) {
        clearInterval(updaters[idx]);
      }
    }

    function wave() {
      // replace the string w/ elements. i write it as a string to start because i
      // couldn't get vscode's html formatter (using one for nunjucks) to not split
      // span elements each onto their own lines, which caused spaces between each
      // letter.
      let header = document.getElementById("header");
      let name = header.innerText;
      let els = [];
      for (let i = 0; i < name.length; i++) {
        let el = document.createElement("span");
        el.innerText = name[i];
        els.push(el);
      }
      header.innerText = '';
      header.append(...els);

      for (let i = 0; i < els.length; i++) {
        frameNs.push(0);
        setTimeout(() => {
          updaters.push(setInterval(fontWeighter.bind(null, i), refresh * 1000));
        }, (baseDelay + charDelay * i) * 1000);
      }
    }

    wave();
  </script>


    </body>

</html>
