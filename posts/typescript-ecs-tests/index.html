<!DOCTYPE html>
<html lang="en">

    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <title>Tests - Maxwell Forbes</title>
        
        <meta content="Tests - Maxwell Forbes" property="title"/>
        <meta content="Tests - Maxwell Forbes" property="og:title"/>
        <meta name="twitter:title" content="Tests - Maxwell Forbes"/>

        <link href='/website-3/assets/img/fav.png' rel='shortcut icon'>
<link href='/website-3/assets/css/tachyons.min.css' rel='stylesheet' type='text/css'/>
<link href='/website-3/assets/css/style.css' rel='stylesheet' type='text/css'/>
<link href='/website-3/assets/css/syntax/prism.default.css' rel='stylesheet' type='text/css'/>



    
    <meta content='https://maxwellforbes.com/posts/typescript-ecs-tests/' property='og:url'/>
    
    <meta name='twitter:site' content='@maxforbes'/>
    
        
        <meta content="The one time I ever wrote tests in making the game Fallgate was after writing the ECS at the very beginning of the..." property='og:description'/>
        <meta name='twitter:description' content="The one time I ever wrote tests in making the game Fallgate was after writing the ECS at the very beginning of the..."/>
    
    <meta content="article" property="og:type"/>




    </head>

    <body class="lh-copy near-black pa0 f5 f4-ns sans-serif">
        

  <div class="mw7 mt3 mt4-ns mb3 center">

    <nav class="mh3 mh4-ns pv3 flex" aria-label="Main">
      <div class="w-50 tl">
        <a href="/website-3/" class="hover dim black" id="header">Maxwell Forbes</a>
      </div>
      <div class="w-50 tr">
        
          
          
            <a class="link hover-mid-gray ml3 pv1" href="/website-3/studio">
              Studio
            </a>
          
        
          
          
            <a class="link hover-mid-gray ml3 pv1" href="/website-3/research">
              Research
            </a>
          
        
      </div>
    </nav>

    <div class="mh3 mh4-ns bt b--black-80"></div>

    <main class="tl relative ph3 ph4-ns pt4 pb2 paddingOverride">
      
        <div class="mb4">
          
          
            <div class="fw600 light-silver mt1 ttu">
              
                05 Sep 2021
              
            </div>
          

          
          <h1 class="ttu tracked f3 f2-ns mt0 lh-title cb mb2">
              Tests
          </h1>
          

        </div>
      

      
      
        <div class="ba b--black-80 mv5">
    <p class="bg-black-80 white mv0 pv2 ph3 b">
        <span class="fr ttu tracked dib white-60 f6 f5-ns">series</span>
        Building an ECS in TypeScript
    </p>

    <div class="pa3">
        
        <ol class="ma0">
            
                <li class="">
                    
                        <a href="/website-3/posts/typescript-ecs-what/" class="db pv1 link">
                            What is an ECS?
                        </a>
                    
                </li>
            
                <li class="">
                    
                        <a href="/website-3/posts/typescript-ecs-why/" class="db pv1 link">
                            Why build an ECS? Why TypeScript?
                        </a>
                    
                </li>
            
                <li class="">
                    
                        <a href="/website-3/posts/typescript-ecs-implementation/" class="db pv1 link">
                            A TypesScript ECS in 99 Lines of Code
                        </a>
                    
                </li>
            
                <li class="">
                    
                        <span class="b">
                            Tests
                        </span>
                    
                </li>
            
                <li class="">
                    
                        <a href="/website-3/posts/typescript-ecs-entities/" class="db pv1 link">
                            Deeper Dive: Entities
                        </a>
                    
                </li>
            
                <li class="">
                    
                        <a href="/website-3/posts/typescript-ecs-components/" class="db pv1 link">
                            Deeper Dive: Components
                        </a>
                    
                </li>
            
                <li class="">
                    
                        <a href="/website-3/posts/typescript-ecs-dirty-component-optimization/" class="db pv1 link">
                            Dirty Component Optimization
                        </a>
                    
                </li>
            
                <li class="">
                    
                        <a href="/website-3/posts/typescript-ecs-aspects/" class="db pv1 link">
                            Aspects
                        </a>
                    
                </li>
            
                <li class="">
                    
                        <a href="/website-3/posts/typescript-ecs-systems/" class="db pv1 link">
                            Deeper Dive: Systems
                        </a>
                    
                </li>
            
        </ol>

    </div>
</div>

      

      <div class="markdown-body">
        <p>The one time I ever wrote tests in making the game Fallgate was after writing the ECS at the very beginning of the project. I only wrote tests because I was in shock at how easy the ECS was to implement. I was sure I’d done something wrong.</p>
<p>Let’s run some simple tests to verify things are working.</p>
<p>To set up our tests, I’m going to define some Components and Systems. Both Components just store data. The Systems will expose a public field called <code>entitiesSeenLastUpdate</code>, which they’ll update during their <code>update()</code>. We’ll use that to check that the Systems are seeing the Entities we expect them to. (Except for the <code>Destroyer</code> System, which we’ll just use to remove our Entities.)</p>
<p>Here’s the definitions of two components and four systems we’ll use:</p>
<pre class="language-ts"><code class="language-ts"><span class="token comment">// Components:</span><br><br><span class="token keyword">class</span> <span class="token class-name">Position</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span><br>    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token keyword">public</span> x<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span> <span class="token keyword">public</span> y<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">class</span> <span class="token class-name">Health</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span><br>    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token keyword">public</span> maximum<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span> <span class="token keyword">public</span> current<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span><br><br><span class="token comment">// Systems:</span><br><br><span class="token keyword">class</span> <span class="token class-name">Locator</span> <span class="token keyword">extends</span> <span class="token class-name">System</span> <span class="token punctuation">{</span><br>    componentsRequired <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set<span class="token operator">&lt;</span><span class="token builtin">Function</span><span class="token operator">></span></span><span class="token punctuation">(</span><span class="token punctuation">[</span>Position<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token keyword">public</span> entitiesSeenLastUpdate<span class="token operator">:</span> <span class="token builtin">number</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><br><br>    <span class="token function">update</span><span class="token punctuation">(</span>entities<span class="token operator">:</span> Set<span class="token operator">&lt;</span>Entity<span class="token operator">></span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span><br>        <span class="token keyword">this</span><span class="token punctuation">.</span>entitiesSeenLastUpdate <span class="token operator">=</span> entities<span class="token punctuation">.</span>size<span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">class</span> <span class="token class-name">Damager</span> <span class="token keyword">extends</span> <span class="token class-name">System</span> <span class="token punctuation">{</span><br>    componentsRequired <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set<span class="token operator">&lt;</span><span class="token builtin">Function</span><span class="token operator">></span></span><span class="token punctuation">(</span><span class="token punctuation">[</span>Health<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token keyword">public</span> entitiesSeenLastUpdate<span class="token operator">:</span> <span class="token builtin">number</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><br><br>    <span class="token function">update</span><span class="token punctuation">(</span>entities<span class="token operator">:</span> Set<span class="token operator">&lt;</span>Entity<span class="token operator">></span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span><br>        <span class="token keyword">this</span><span class="token punctuation">.</span>entitiesSeenLastUpdate <span class="token operator">=</span> entities<span class="token punctuation">.</span>size<span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">class</span> <span class="token class-name">HealthBarRenderer</span> <span class="token keyword">extends</span> <span class="token class-name">System</span> <span class="token punctuation">{</span><br>    componentsRequired <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set<span class="token operator">&lt;</span><span class="token builtin">Function</span><span class="token operator">></span></span><span class="token punctuation">(</span><span class="token punctuation">[</span>Position<span class="token punctuation">,</span> Health<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token keyword">public</span> entitiesSeenLastUpdate<span class="token operator">:</span> <span class="token builtin">number</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><br><br>    <span class="token function">update</span><span class="token punctuation">(</span>entities<span class="token operator">:</span> Set<span class="token operator">&lt;</span>Entity<span class="token operator">></span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span><br>        <span class="token keyword">this</span><span class="token punctuation">.</span>entitiesSeenLastUpdate <span class="token operator">=</span> entities<span class="token punctuation">.</span>size<span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">class</span> <span class="token class-name">Destroyer</span> <span class="token keyword">extends</span> <span class="token class-name">System</span> <span class="token punctuation">{</span><br>    componentsRequired <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set<span class="token operator">&lt;</span><span class="token builtin">Function</span><span class="token operator">></span></span><span class="token punctuation">(</span><span class="token punctuation">[</span>Health<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token function">update</span><span class="token punctuation">(</span>entities<span class="token operator">:</span> Set<span class="token operator">&lt;</span>Entity<span class="token operator">></span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span><br>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> entity <span class="token keyword">of</span> entities<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>            <span class="token keyword">this</span><span class="token punctuation">.</span>ecs<span class="token punctuation">.</span><span class="token function">removeEntity</span><span class="token punctuation">(</span>entity<span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre>
<p>The testing code is going to look terrible to anyone who actually writes tests using a good library or tool. I’m just using <code>console.log()</code> to print whether conditions we expect to be true indeed are. Why? It was quick and easy. And testing isn’t really a main focus of what we’re doing overall.</p>
<pre class="language-ts"><code class="language-ts"><span class="token keyword">function</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"Running basic test."</span><span class="token punctuation">)</span><br>    <span class="token keyword">let</span> ecs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token constant">ECS</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token comment">// Try out basic Component operations.</span><br>    <span class="token keyword">let</span> entity1 <span class="token operator">=</span> ecs<span class="token punctuation">.</span><span class="token function">addEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">let</span> position1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Position</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    ecs<span class="token punctuation">.</span><span class="token function">addComponent</span><span class="token punctuation">(</span>entity1<span class="token punctuation">,</span> position1<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><br>        ecs<span class="token punctuation">.</span><span class="token function">getComponents</span><span class="token punctuation">(</span>entity1<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>Position<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"-- component adding"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">let</span> gotP <span class="token operator">=</span> ecs<span class="token punctuation">.</span><span class="token function">getComponents</span><span class="token punctuation">(</span>entity1<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>Position<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><br>        gotP<span class="token punctuation">.</span>x <span class="token operator">==</span> position1<span class="token punctuation">.</span>x <span class="token operator">&amp;&amp;</span> gotP<span class="token punctuation">.</span>y <span class="token operator">==</span> position1<span class="token punctuation">.</span>y<span class="token punctuation">,</span><br>        <span class="token string">"-- component retrieval"</span><br>    <span class="token punctuation">)</span><span class="token punctuation">;</span><br>    ecs<span class="token punctuation">.</span><span class="token function">removeComponent</span><span class="token punctuation">(</span>entity1<span class="token punctuation">,</span> Position<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><br>        <span class="token operator">!</span>ecs<span class="token punctuation">.</span><span class="token function">getComponents</span><span class="token punctuation">(</span>entity1<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>Position<span class="token punctuation">)</span><span class="token punctuation">,</span><br>        <span class="token string">"-- component deletion"</span><br>    <span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token comment">// Try out basic System operations.</span><br>    <span class="token keyword">let</span> locator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Locator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    ecs<span class="token punctuation">.</span><span class="token function">addSystem</span><span class="token punctuation">(</span>locator<span class="token punctuation">)</span><br>    <span class="token comment">// Important note: we don't call `update()` here to update the</span><br>    <span class="token comment">// system's tracking of entities. That happens automatically. We're</span><br>    <span class="token comment">// doing it because we had the Locator set its</span><br>    <span class="token comment">// `entitiesSeenLastUpdate` field when its `update()` is called. This</span><br>    <span class="token comment">// way we can verify it's updating correctly without peeking into</span><br>    <span class="token comment">// private state.</span><br>    ecs<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><br>        locator<span class="token punctuation">.</span>entitiesSeenLastUpdate <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">,</span><br>        <span class="token string">"-- system doesn't track w/o match"</span><br>    <span class="token punctuation">)</span><span class="token punctuation">;</span><br>    ecs<span class="token punctuation">.</span><span class="token function">addComponent</span><span class="token punctuation">(</span>entity1<span class="token punctuation">,</span> position1<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    ecs<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><br>        locator<span class="token punctuation">.</span>entitiesSeenLastUpdate <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">,</span><br>        <span class="token string">"-- system does track w/ match"</span><br>    <span class="token punctuation">)</span><span class="token punctuation">;</span><br>    ecs<span class="token punctuation">.</span><span class="token function">removeComponent</span><span class="token punctuation">(</span>entity1<span class="token punctuation">,</span> Position<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    ecs<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><br>        locator<span class="token punctuation">.</span>entitiesSeenLastUpdate <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">,</span><br>        <span class="token string">"-- system removes tracking w/o match"</span><br>    <span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">let</span> health1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Health</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    ecs<span class="token punctuation">.</span><span class="token function">addComponent</span><span class="token punctuation">(</span>entity1<span class="token punctuation">,</span> position1<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    ecs<span class="token punctuation">.</span><span class="token function">addComponent</span><span class="token punctuation">(</span>entity1<span class="token punctuation">,</span> health1<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    ecs<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><br>        locator<span class="token punctuation">.</span>entitiesSeenLastUpdate <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">,</span><br>        <span class="token string">"-- system does track w/ superset"</span><br>    <span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token comment">// Try out Systems that track multiple Components.</span><br>    <span class="token keyword">let</span> damager <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Damager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    ecs<span class="token punctuation">.</span><span class="token function">addSystem</span><span class="token punctuation">(</span>damager<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">let</span> healthBarRenderer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HealthBarRenderer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    ecs<span class="token punctuation">.</span><span class="token function">addSystem</span><span class="token punctuation">(</span>healthBarRenderer<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">let</span> entity2 <span class="token operator">=</span> ecs<span class="token punctuation">.</span><span class="token function">addEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">let</span> health2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Health</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    ecs<span class="token punctuation">.</span><span class="token function">addComponent</span><span class="token punctuation">(</span>entity2<span class="token punctuation">,</span> health2<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token comment">// At this point:</span><br>    <span class="token comment">// e1 has Position, Health; should be tracked by Loc, Dmg, HBR</span><br>    <span class="token comment">// e2 has           Health; should be tracked by      Dmg</span><br>    ecs<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Again, call to update Systems' records.</span><br>    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><br>        locator<span class="token punctuation">.</span>entitiesSeenLastUpdate <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">,</span><br>        <span class="token string">"-- Locator tracking 1 entity"</span><br>    <span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><br>        damager<span class="token punctuation">.</span>entitiesSeenLastUpdate <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">,</span><br>        <span class="token string">"-- Damager tracking 2 entities"</span><br>    <span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><br>        healthBarRenderer<span class="token punctuation">.</span>entitiesSeenLastUpdate <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">,</span><br>        <span class="token string">"-- HealthBarRenderer tracking 1 entity"</span><br>    <span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token comment">// Try out Systems that remove entities. The Destroyer should mark</span><br>    <span class="token comment">// both of our Entities for removal when `update()` is called---but</span><br>    <span class="token comment">// crucially, the other Systems should still be able to see Entities</span><br>    <span class="token comment">// during their `update()`. This is because we've defined</span><br>    <span class="token comment">// `removeEntity` to *mark* entities for removal, but actually remove</span><br>    <span class="token comment">// them at the end of the `update()` call. We haven't implemented</span><br>    <span class="token comment">// priority ordering yet, so right now Systems update in Map</span><br>    <span class="token comment">// iteration order, which is insertion order</span><br>    <span class="token comment">// (https://developer.mozilla.org/en-US/docs/Web/JavaScript/</span><br>    <span class="token comment">/// Reference/Global_Objects/Map).</span><br>    <span class="token comment">// Thus, to make sure that our "remove at end of `update()`" behavior</span><br>    <span class="token comment">// is actually working, we'll remove the other Systems, add the</span><br>    <span class="token comment">// Destroyer first, and then add the others back in.</span><br>    ecs<span class="token punctuation">.</span><span class="token function">removeSystem</span><span class="token punctuation">(</span>locator<span class="token punctuation">)</span><br>    ecs<span class="token punctuation">.</span><span class="token function">removeSystem</span><span class="token punctuation">(</span>damager<span class="token punctuation">)</span><br>    ecs<span class="token punctuation">.</span><span class="token function">removeSystem</span><span class="token punctuation">(</span>healthBarRenderer<span class="token punctuation">)</span><br>    <span class="token keyword">let</span> destroyer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Destroyer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    ecs<span class="token punctuation">.</span><span class="token function">addSystem</span><span class="token punctuation">(</span>destroyer<span class="token punctuation">)</span><br>    ecs<span class="token punctuation">.</span><span class="token function">addSystem</span><span class="token punctuation">(</span>locator<span class="token punctuation">)</span><br>    ecs<span class="token punctuation">.</span><span class="token function">addSystem</span><span class="token punctuation">(</span>damager<span class="token punctuation">)</span><br>    ecs<span class="token punctuation">.</span><span class="token function">addSystem</span><span class="token punctuation">(</span>healthBarRenderer<span class="token punctuation">)</span><br>    ecs<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// All Entities removed.</span><br>    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><br>        locator<span class="token punctuation">.</span>entitiesSeenLastUpdate <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">,</span><br>        <span class="token string">"-- Locator: entity not removed during update"</span><br>    <span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><br>        damager<span class="token punctuation">.</span>entitiesSeenLastUpdate <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">,</span><br>        <span class="token string">"-- Damager: entity not removed during update"</span><br>    <span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><br>        healthBarRenderer<span class="token punctuation">.</span>entitiesSeenLastUpdate <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">,</span><br>        <span class="token string">"-- HealthBarRenderer: entity not removed during update"</span><br>    <span class="token punctuation">)</span><span class="token punctuation">;</span><br>    ecs<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Everyone should have seen zero this round.</span><br>    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><br>        locator<span class="token punctuation">.</span>entitiesSeenLastUpdate <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">,</span><br>        <span class="token string">"-- Locator: entities gone "</span><br>    <span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><br>        damager<span class="token punctuation">.</span>entitiesSeenLastUpdate <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"-- Damager: entities gone"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><br>        healthBarRenderer<span class="token punctuation">.</span>entitiesSeenLastUpdate <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">,</span><br>        <span class="token string">"-- HealthBarRenderer: entities gone"</span><br>    <span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<script src="/website-3/assets/posts/typescript-ecs/01-pure-ecs.js"></script>
<h2 id="you-already-ran-this-test" tabindex="-1">You Already Ran This Test</h2>
<a class="dn" href="#you-already-ran-this-test"><span class="dn">Permalink to “You Already Ran This Test”</span> <span aria-hidden="true">#</span></a><p>Does the ECS pass this test? You tell me. The ECS is running on this webpage, and the test ran as soon as you loaded it. If you’re on a Desktop, open up your developer tools console and check what you see.<sup class="footnote-ref"><a href="#fn1" id="fnref1">[1]</a></sup></p>
<p>This is what I see:</p>
<p><img src="/website-3/assets/posts/typescript-ecs/test-results.jpg" alt=""></p>
<h2 id="try-it-out" tabindex="-1">Try It Out</h2>
<a class="dn" href="#try-it-out"><span class="dn">Permalink to “Try It Out”</span> <span aria-hidden="true">#</span></a><p>In case you’d like to try out the <code>ECS</code> yourself, I’ve also exposed it and the above Components and Systems on this page. In the console, try something like</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">let</span> ecs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ECS</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>ecs<span class="token punctuation">.</span><span class="token function">addEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>… and see whether it gives you <code>0</code> back.</p>
<hr class="footnotes-sep">
<section class="footnotes">
<ol class="footnotes-list">
<li id="fn1" class="footnote-item"><p>If you’re not familiar with opening developer tools on a webpage, just Google “open developer tools &lt;browser&gt;”. For Chrome on a Mac, Cmd+Shift+C works. <a href="#fnref1" class="footnote-backref">↩︎</a></p>
</li>
</ol>
</section>

      </div>

      
      
        <div class="ba b--black-10 mv5">
    <p class="bg-near-white black-60 mv0 pv2 ph3 b">
        <span class="fr ttu tracked dib black-30 f6 f5-ns">series</span>
        Building an ECS in TypeScript
    </p>

    <div class="pa3 flex">
        <div class="w-50 ma0">
            
            
                <p class="b ttu tracked ma0 black-30 f7 f6-ns">&larr; previous</p>
                <a href="/website-3/posts/typescript-ecs-implementation/" class=" ma0 link">3. A TypesScript ECS in 99 Lines of Code</a>
            
        </div>
        <div class="w-50 ma0 tr">
            
            
                <p class="b ttu tracked ma0 black-30 f7 f6-ns">next &rarr;</p>
                <a href="/website-3/posts/typescript-ecs-entities/" class=" ma0 link">5. Deeper Dive: Entities</a>
            
        </div>
    </div>
</div>

      

      
      <!-- <hr /> -->
<!-- <div class="bt b--black-80 mt4"></div> -->
<div class="ba b--black-80 mt5 f6 f5-ns">
    <form style="text-align:center;" action="https://tinyletter.com/mbforbes" method="post" target="popupwindow"
        onsubmit="window.open('https://tinyletter.com/mbforbes', 'popupwindow', 'scrollbars=yes,width=800,height=600');return true">
        <p class="tc b">
            Monthly project and essay digest
        </p>
        <p class="tc measure center">
            <label for="tlemail">
                I send a summary every month of my new projects and essays.
                No spam, just me, Max. Unsub whenever.
            </label>
        </p>
        <p class="mb1">
            <input type="text" style="width:200px" name="email" id="tlemail" placeholder="your email"/>
            <input type="hidden" value="1" name="embed"/><input type="submit" value="Get on the list"/>
        </p>
        <p class="mt0 f7 f6-ns">
            <!-- via -->
            <img src='/website-3/assets/img/TinyLetter_Wordmark.png' style="height: 22px;"/>
        </p>
    </form>
</div>


      
      
    </main>
  </div>
  <footer class="mt5 f6 f5-ns mw7 center tc pt2 pb4 silver">
    <div class="mh3 mh4-ns bt b--silver mb1"></div>
    <a href="/website-3/about/" class="link silver hover-blue pv1">
      about me
    </a>
    | orig theme is
    <a href="http://github.com/muan/scribble" class="link silver hover-blue pv1">Scribble</a>
    <!-- <img src="https://maxwellforbes.com/data/img/scribble2.png" alt="scribble" class="mt4 db center" /> -->
  </footer>

  
  <script>
    // settings
    let periods = 0.5;
    let baseDelay = 1; // s
    let charDelay = 0.1; // s
    let duration = 0.70; // s
    let startW = 400; // w
    let mag = 400; // +/- w
    let refresh = 0.016667; // s

    // computed vals
    let frames = duration / refresh;

    // state
    let updaters = [];
    let frameNs = [];

    function fontWeighter(idx) {
      frameNs[idx] += 1;
      let x = (frameNs[idx] / frames) * periods * 2 * Math.PI;
      let w = Math.round(startW + mag * Math.sin(x));
      document
        .getElementById("header")
        .children[idx]
        .style
        .fontWeight = w;
      if (frameNs[idx] >= frames) {
        clearInterval(updaters[idx]);
      }
    }

    function wave() {
      // replace the string w/ elements. i write it as a string to start because i
      // couldn't get vscode's html formatter (using one for nunjucks) to not split
      // span elements each onto their own lines, which caused spaces between each
      // letter.
      let header = document.getElementById("header");
      let name = header.innerText;
      let els = [];
      for (let i = 0; i < name.length; i++) {
        let el = document.createElement("span");
        el.innerText = name[i];
        els.push(el);
      }
      header.innerText = '';
      header.append(...els);

      for (let i = 0; i < els.length; i++) {
        frameNs.push(0);
        setTimeout(() => {
          updaters.push(setInterval(fontWeighter.bind(null, i), refresh * 1000));
        }, (baseDelay + charDelay * i) * 1000);
      }
    }

    wave();
  </script>


    </body>

</html>
